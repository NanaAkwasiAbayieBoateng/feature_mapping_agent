<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-Park: AI MAPPING ENGINE FOR FINANCIAL DATA SYSTEMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background */
            color: #e2e8f0; /* Light text color */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #2a2a2a; /* Slightly lighter dark for container */
            padding: 32px;
            border-radius: 16px; /* Slightly more rounded */
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4); /* Stronger shadow for depth */
            max-width: 800px;
            width: 100%;
            border: 1px solid #4a4a4a; /* Subtle border */
            background-image: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%); /* Subtle gradient */
        }
        h1 {
            font-size: 7.5rem; /* Increased title size significantly */
            font-weight: 700;
            color: #3b82f6; /* Blue color for title */
            margin-bottom: 24px;
            text-align: center;
            letter-spacing: -0.025em;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.6); /* Subtle blue glow */
        }
        label {
            display: block;
            font-weight: 500;
            color: #cbd5e1; /* Lighter grey for labels */
            margin-bottom: 8px; /* Increased margin */
        }
        input[type="file"], input[type="text"] {
            width: 100%;
            padding: 12px 14px; /* Slightly more padding */
            border: 1px solid #4a4a4a; /* Darker border */
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 1rem;
            color: #e2e8f0; /* Light text color */
            background-color: #3a3a3a; /* Darker input background */
            box-sizing: border-box;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="file"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #6366f1; /* Indigo-500 for focus */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); /* Focus ring */
        }
        input[type="file"]::file-selector-button {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #4338ca; /* Indigo-700 */
        }
        button {
            width: 100%;
            padding: 14px 20px; /* More padding for buttons */
            background-image: linear-gradient(45deg, #4f46e5 0%, #6366f1 100%); /* Indigo gradient */
            color: white;
            border: none;
            border-radius: 10px; /* More rounded buttons */
            font-size: 1.125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); /* Shadow matching gradient */
        }
        button:hover {
            background-image: linear-gradient(45deg, #4338ca 0%, #5a57d8 100%); /* Darker gradient on hover */
            transform: translateY(-2px); /* Lift effect */
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
        }
        .flash-message {
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 8px;
            font-weight: 500;
            color: #e2e8f0; /* Light text for messages */
        }
        .flash-info {
            background-color: #3b82f6; /* Blue-500 */
            border: 1px solid #60a5fa; /* Blue-400 */
        }
        .flash-success {
            background-color: #16a34a; /* Green-600 */
            border: 1px solid #22c55e; /* Green-500 */
        }
        .flash-error {
            background-color: #dc2626; /* Red-600 */
            border: 1px solid #ef4444; /* Red-500 */
        }
        .file-section {
            border: 1px dashed #4a4a4a; /* Darker dashed border */
            padding: 24px; /* More padding */
            border-radius: 12px;
            margin-bottom: 28px; /* Increased margin */
            background-color: #2f2f2f; /* Slightly lighter than container for contrast */
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.2); /* Inner shadow */
        }
        .file-section h2 {
            font-size: 1.0rem; /* Section titles remain 1.5rem */
            font-weight: 600;
            color: #e2e8f0; /* Light text color */
            margin-bottom: 18px;
            text-align: center;
        }
        .download-section {
            margin-top: 32px; /* Increased margin */
            text-align: center;
            padding-top: 20px;
            border-top: 1px dashed #4a4a4a; /* Separator */
        }
        .download-section p {
            margin-bottom: 16px;
            color: #cbd5e1;
        }
        #processing-time {
            margin-top: 12px;
            font-weight: 600;
            color: #93c5fd; /* Light blue for time */
            text-align: center;
        }
        .slider-container {
            margin-bottom: 28px;
            padding: 20px;
            background-color: #2f2f2f; /* Darker background for slider */
            border-radius: 12px;
            border: 1px solid #4a4a4a;
            box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.2);
        }
        .slider-container label {
            margin-bottom: 12px;
            text-align: center;
            font-size: 1.1rem; /* Slightly larger label */
        }
        .slider-container input[type="range"] {
            width: calc(100% - 20px);
            margin: 0 auto;
            display: block;
            height: 10px; /* Thicker track */
            background: #4a4a4a; /* Darker track color */
            border-radius: 5px;
            outline: none;
            opacity: 0.9; /* More opaque */
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        .slider-container input[type="range"]::-webkit-slider-thumb {
            width: 24px; /* Larger thumb */
            height: 24px;
            border-radius: 50%;
            background: #6366f1; /* Indigo-500 thumb color */
            cursor: grab; /* Grab cursor */
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
            -webkit-transition: background-color 0.2s ease-in-out;
            transition: background-color 0.2s ease-in-out;
        }
        .slider-container input[type="range"]::-webkit-slider-thumb:active {
            cursor: grabbing;
        }
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #6366f1;
            cursor: grab;
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.4);
            transition: background-color 0.2s ease-in-out;
        }
        .slider-container input[type="range"]::-moz-range-thumb:active {
            cursor: grabbing;
        }
        #threshold-value {
            text-align: center;
            font-weight: 700;
            color: #93c5fd; /* Light blue for value */
            margin-top: 10px;
            font-size: 1.2rem;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6366f1; /* Indigo-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Drag and Drop Styles */
        .drop-zone {
            border: 2px dashed #6366f1; /* Indigo dashed border */
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #3a3a3a; /* Darker background for drop zone */
            color: #cbd5e1;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            margin-bottom: 16px; /* Space between drop zone and other elements */
        }
        .drop-zone.highlight {
            background-color: #4f46e5; /* Indigo-600 on drag over */
            border-color: #818cf8; /* Lighter indigo border */
        }
        .drop-zone p {
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .drop-zone input[type="file"] {
            display: none; /* Hide the default file input */
        }
        .drop-zone .file-upload-label {
            display: inline-block;
            background-color: #4f46e5;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .drop-zone .file-upload-label:hover {
            background-color: #4338ca;
        }
        .file-name-display {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #93c5fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>X-Park: AI MAPPING ENGINE FOR FINANCIAL DATA SYSTEMS</h1>

        <div id="flash-messages"></div>

        <form id="uploadForm" class="space-y-6">
            <div class="file-section">
                <h2>Internal File: Raw Data for Standardization</h2>
                <div id="drop-zone-file1" class="drop-zone">
                    <input type="file" name="file1" id="file1" accept=".xls,.xlsx,.csv,.json,.txt,.docx" required>
                    <p>Drag & Drop your file here, or</p>
                    <label for="file1" class="file-upload-label">Browse Files</label>
                    <div class="file-name-display" id="file1-name">No file selected</div>
                </div>

                <label for="field_name_col1">Field Name Column (for tabular files):</label>
                <input type="text" name="field_name_col1" id="field_name_col1" value="Field Name">
                <p class="text-sm text-gray-400 mt-1">For .txt/.docx, the filename will be used as a default field name.</p>

                <label for="description_col1">Description Column (for tabular files):</label>
                <input type="text" name="description_col1" id="description_col1" value="Description">
                <p class="text-sm text-gray-400 mt-1">For .txt/.docx, the entire file content will be used as the description.</p>
            </div>

            <div class="file-section">
                <h2>External File: Standardized Lookup Data</h2>
                <div id="drop-zone-file2" class="drop-zone">
                    <input type="file" name="file2" id="file2" accept=".xls,.xlsx,.csv,.json" required>
                    <p>Drag & Drop your file here, or</p>
                    <label for="file2" class="file-upload-label">Browse Files</label>
                    <div class="file-name-display" id="file2-name">No file selected</div>
                </div>

                <label for="standardized_name_col2">Standardized Name Column:</label>
                <input type="text" name="standardized_name_col2" id="standardized_name_col2" value="Standardized Name">

                <label for="description_col2">Description Column:</label>
                <input type="text" name="description_col2" id="description_col2" value="Description">
            </div>

            <div class="slider-container">
                <label for="min_score_threshold">Minimum Cosine Similarity Score for Match:</label>
                <input type="range" id="min_score_threshold" name="min_score_threshold" min="0" max="100" value="70" step="1">
                <div id="threshold-value">70%</div>
                <p class="text-sm text-gray-400 mt-1">Adjust this to define how strict the matching should be. (0-100 scale)</p>
            </div>

            <button type="submit">Process & Match Files</button>
        </form>

        <div id="download-section" class="download-section hidden">
            <p>Your files have been processed.</p>
            <div id="processing-time"></div>
            <button id="downloadButton">Download Matched File</button>
        </div>
    </div>

    <script>
        // Function to format seconds into H:M:S
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);

            let timeString = '';
            if (hours > 0) {
                timeString += `${hours} hour${hours !== 1 ? 's' : ''}, `;
            }
            if (minutes > 0 || hours > 0) { // Show minutes if there are any, or if there are hours (for clarity)
                timeString += `${minutes} minute${minutes !== 1 ? 's' : ''}, `;
            }
            timeString += `${seconds} second${seconds !== 1 ? 's' : ''}`;

            return timeString;
        }

        // Update slider value display
        const slider = document.getElementById('min_score_threshold');
        const thresholdValueDisplay = document.getElementById('threshold-value');

        slider.oninput = function() {
            thresholdValueDisplay.innerHTML = this.value + '%';
        };

        // --- Drag and Drop Functionality ---
        function setupDropZone(dropZoneId, fileInputId, fileNameDisplayId) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileNameDisplay = document.getElementById(fileNameDisplayId);

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false); // Global prevent default
            });

            // Highlight drop zone when dragging over
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('highlight'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('highlight'), false);
            });

            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    fileInput.files = files; // Assign files to the hidden input
                    fileNameDisplay.textContent = files[0].name; // Display file name
                }
            }

            // Update file name display when file is selected via browse button
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileNameDisplay.textContent = this.files[0].name;
                } else {
                    fileNameDisplay.textContent = 'No file selected';
                }
            });
        }

        // Setup drop zones for both file inputs
        setupDropZone('drop-zone-file1', 'file1', 'file1-name');
        setupDropZone('drop-zone-file2', 'file2', 'file2-name');


        document.getElementById('uploadForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            const form = event.target;
            const formData = new FormData();

            // Append File 1 data
            const file1Input = document.getElementById('file1');
            if (file1Input.files.length === 0) {
                document.getElementById('flash-messages').innerHTML = '<div class="flash-message flash-error">Please select or drag and drop File 1.</div>';
                return;
            }
            formData.append('file1', file1Input.files[0]);
            formData.append('field_name_col1', form.elements['field_name_col1'].value);
            formData.append('description_col1', form.elements['description_col1'].value);

            // Append File 2 data
            const file2Input = document.getElementById('file2');
            if (file2Input.files.length === 0) {
                document.getElementById('flash-messages').innerHTML = '<div class="flash-message flash-error">Please select or drag and drop File 2.</div>';
                return;
            }
            formData.append('file2', file2Input.files[0]);
            formData.append('standardized_name_col2', form.elements['standardized_name_col2'].value);
            formData.append('description_col2', form.elements['description_col2'].value);

            // Append slider value (normalize to 0-1 range for backend)
            const minScoreThreshold = parseFloat(slider.value) / 100.0;
            formData.append('min_score_threshold', minScoreThreshold);


            // Show a loading message with spinner
            const flashMessagesDiv = document.getElementById('flash-messages');
            flashMessagesDiv.innerHTML = '<div class="flash-message flash-info"><span class="spinner"></span>Processing files... This may take a while due to Ollama semantic matching and ChromaDB operations.</div>';
            document.getElementById('download-section').classList.add('hidden');
            document.getElementById('processing-time').innerHTML = ''; // Clear previous time
            document.getElementById('uploadForm').querySelector('button[type="submit"]').disabled = true;


            try {
                const response = await fetch('/process_files/', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    flashMessagesDiv.innerHTML = `<div class="flash-message flash-success">${result.message}</div>`;
                    const downloadButton = document.getElementById('downloadButton');
                    downloadButton.onclick = () => window.location.href = `/download/${result.download_filename}`;

                    // Display processing time in H:M:S
                    if (result.processing_time_seconds !== undefined) {
                        const formattedTime = formatTime(result.processing_time_seconds);
                        document.getElementById('processing-time').innerHTML = `Matching completed in: <strong>${formattedTime}</strong>`;
                    }

                    document.getElementById('download-section').classList.remove('hidden');
                } else {
                    flashMessagesDiv.innerHTML = `<div class="flash-message flash-error">Error: ${result.detail || 'Unknown error occurred.'}</div>`;
                }
            } catch (error) {
                flashMessagesDiv.innerHTML = `<div class="flash-message flash-error">Network error or server unreachable: ${error.message}</div>`;
            } finally {
                document.getElementById('uploadForm').querySelector('button[type="submit"]').disabled = false;
            }
        });
    </script>
</body>
</html>
